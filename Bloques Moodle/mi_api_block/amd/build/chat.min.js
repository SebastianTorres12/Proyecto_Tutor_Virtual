define("block_mi_api_block/chat",["jquery"],(function($){const API_Moodle="http://localhost/webservice/rest/server.php";function obtenerContextoEstudiante(userid,courseid,forceRefresh){return new Promise((function(resolve){var contextoKey="contexto_estudiante_"+userid+"_"+courseid;if(!forceRefresh){var contextoGuardado=sessionStorage.getItem(contextoKey);if(contextoGuardado)try{var notas=JSON.parse(contextoGuardado);return void resolve(notas)}catch(e){}}var params={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"gradereport_user_get_grade_items",moodlewsrestformat:"json",courseid:courseid,userid:userid};$.ajax({url:`${API_Moodle}?${$.param(params)}`,method:"GET",dataType:"json",success:function(data){var notas=[];data.usergrades&&data.usergrades.forEach((user=>{user.gradeitems.forEach((item=>{if(item.itemname){var grade=null!==item.graderaw?item.graderaw:0;notas.push({userid:user.userid,name:user.userfullname,grade:grade,actividad:item.itemname})}}))})),sessionStorage.setItem(contextoKey,JSON.stringify(notas)),resolve(notas)},error:function(){resolve([])}})}))}function llamarAPITutor(instruccion,entrada,maxTokens){return new Promise((function(resolve,reject){$.ajax({url:"http://localhost:8000/generar",method:"POST",contentType:"application/json",data:JSON.stringify({instruccion:instruccion,entrada:entrada,max_nuevos_tokens:maxTokens||1e3}),success:function(response){response.respuesta?resolve({respuesta:response.respuesta}):reject(new Error("Respuesta inv치lida de la API"))},error:function(xhr,status,error){reject(new Error(error))}})}))}return{init:function(userid,courseid,role){var messagesDiv=$("#chat-messages"),form=$("#chat-form"),chatInput=$("#chat-input"),submitButton=form.find('button[type="submit"]'),isChatBlocked=!1;function scrollToBottom(){messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}function showTutorLoader(){var loader=$('<div class="chat-bubble tutor-bubble tutor-loader"></div>').html("<span><em>El tutor est치 escribiendo...</em></span>");messagesDiv.append(loader),scrollToBottom()}function removeTutorLoader(){messagesDiv.find(".tutor-loader").remove()}function animateTutorMessage(htmlMsg){removeTutorLoader();var bubble=$('<div class="chat-bubble tutor-bubble"></div>');bubble.append("<span></span>"),messagesDiv.append(bubble),scrollToBottom();var safeHtml=htmlMsg.replace(/\*\*([^*]+)\*\*/g,(function(match,p1){return"<b>"+p1.replace(/\n/g,"<br>")+"</b>"})).replace(/```([a-zA-Z]*)\n([\s\S]*?)```/g,(function(match,lang,code){return"<pre><code>"+$("<div>").text(code).html().replace(/\n/g,"<br>")+"</code></pre>"})).replace(/\n{2,}/g,"<br><br>").replace(/\n/g,"<br>").replace(/<(?!br\s*\/?>|b>|\/b>|strong>|\/strong>|i>|\/i>|pre>|\/pre>|code>|\/code>)[^>]+>/gi,""),i=0;!function typeChar(){i<=safeHtml.length?(bubble.find("span").html(safeHtml.slice(0,i)),scrollToBottom(),i++,setTimeout(typeChar,12)):(bubble.find("span").html(safeHtml),bubble.find("pre").each((function(){var $pre=$(this),codeText=$pre.find("code").text()||$pre.text(),codeHtml=$pre.find("code").html()||$pre.html(),$actions=$('<div class="code-actions"></div>'),$copyBtn=$('<button class="code-action-btn copy-btn" title="Copiar c칩digo">游늶</button>');$copyBtn.on("click",(function(e){var $notification,text,htmlSource;e.stopPropagation(),text=codeText,(htmlSource=codeHtml)&&(text=htmlSource.replace(/<br\s*\/?>/gi,"\n").replace(/<pre>|<code>|<\/pre>|<\/code>/gi,"").replace(/&nbsp;/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&amp;/gi,"&")),navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(text).catch((function(){fallbackCopyToClipboard(text)})):fallbackCopyToClipboard(text),$notification=$('<div class="copy-notification">C칩digo copiado al portapapeles</div>'),$("body").append($notification),setTimeout((function(){$notification.addClass("show")}),10),setTimeout((function(){$notification.removeClass("show"),setTimeout((function(){$notification.remove()}),300)}),2e3)}));var $expandBtn=$('<button class="code-action-btn expand-btn" title="Ver en ventana ampliada">游댌</button>');$expandBtn.on("click",(function(e){e.stopPropagation(),function(codeText){var $modal=$("#code-modal");0===$modal.length&&($modal=$('<div id="code-modal" class="code-modal"><div class="code-modal-content"><div class="code-modal-header"><h3>C칩digo</h3><span class="code-modal-close">&times;</span></div><div class="code-modal-body"><pre><code></code></pre></div></div></div>'),$("body").append($modal),$modal.find(".code-modal-close").on("click",(function(){$modal.hide()})),$modal.on("click",(function(e){e.target===this&&$modal.hide()})),$(document).on("keydown",(function(e){"Escape"===e.key&&$modal.is(":visible")&&$modal.hide()})));var formattedCode=codeText.replace(/<br\s*\/?>/gi,"\n").replace(/<[^>]+>/g,"");$modal.find("code").text(formattedCode),$modal.show()}(codeText)})),$actions.append($copyBtn).append($expandBtn),$pre.css("position","relative").append($actions)})),bubble.find("pre code").each((function(){var formattedCode=$(this).html().replace(/<br\s*\/?>/gi,"\n");$(this).text(formattedCode)})),scrollToBottom())}()}function fallbackCopyToClipboard(text){var textArea=document.createElement("textarea");textArea.value=text,textArea.style.position="fixed",textArea.style.left="-999999px",textArea.style.top="-999999px",document.body.appendChild(textArea),textArea.focus(),textArea.select();try{document.execCommand("copy")}catch(err){console.error("Error al copiar texto: ",err)}document.body.removeChild(textArea)}function showTutor(msg){animateTutorMessage(msg)}function verificarIntentosCuestionario(callback){var params={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"gradereport_user_get_grade_items",moodlewsrestformat:"json",courseid:courseid,userid:userid};$.ajax({url:`${API_Moodle}?${$.param(params)}`,method:"GET",dataType:"json",success:function(data){var actividades=[];if(data.usergrades&&data.usergrades.forEach((user=>{user.gradeitems.forEach((item=>{item.itemname&&item.cmid&&actividades.push({cmid:item.cmid,name:item.itemname})}))})),0!==actividades.length){var quizzes=[],promises=actividades.map((actividad=>{var paramsContext={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"core_course_get_course_module",moodlewsrestformat:"json",cmid:actividad.cmid};return $.ajax({url:`${API_Moodle}?${$.param(paramsContext)}`,method:"GET",dataType:"json",success:function(contextData){contextData.cm&&"quiz"===contextData.cm.modname&&quizzes.push({quizid:contextData.cm.instance,name:actividad.name})}})}));Promise.all(promises).then((()=>{if(0!==quizzes.length){var attemptPromises=quizzes.map((quiz=>{var paramsAttempts={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"mod_quiz_get_user_attempts",moodlewsrestformat:"json",quizid:quiz.quizid,userid:userid,status:"all",includepreviews:0};return $.ajax({url:`${API_Moodle}?${$.param(paramsAttempts)}`,method:"GET",dataType:"json",success:function(attemptData){attemptData.attempts&&attemptData.attempts.length>0&&(attemptData.attempts.find((attempt=>"inprogress"===attempt.state))&&(isChatBlocked=!0,showTutor("No puedes enviar mensajes mientras est치s realizando un cuestionario en curso."),chatInput.prop("disabled",!0),submitButton.prop("disabled",!0)))}})}));Promise.all(attemptPromises).then((()=>{isChatBlocked||callback&&setTimeout(callback,0)})).catch((()=>{showTutor("Error al verificar intentos de cuestionarios."),callback&&setTimeout(callback,0)}))}else callback&&setTimeout(callback,0)})).catch((()=>{showTutor("Error al verificar actividades."),callback&&setTimeout(callback,0)}))}else callback&&callback()},error:function(xhr,status,error){showTutor("Error al obtener actividades: "+error+" (C칩digo: "+xhr.status+")"),callback&&callback()}})}function obtenerRecomendaciones(){showTutorLoader();var params={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"gradereport_user_get_grade_items",moodlewsrestformat:"json",courseid:courseid,userid:userid};$.ajax({url:`${API_Moodle}?${$.param(params)}`,method:"GET",dataType:"json",success:function(data){var notas=[];if(data.usergrades&&data.usergrades.forEach((user=>{user.gradeitems.forEach((item=>{if(item.itemname){var grade=null!==item.graderaw?item.graderaw:0;grade>0&&notas.push({userid:user.userid,name:user.userfullname,grade:grade,actividad:item.itemname})}}))})),0===notas.length)return removeTutorLoader(),void showTutor("No hay actividades con notas mayores a 0 para analizar.");llamarAPITutor('Act칰a como un tutor virtual especializado en la ense침anza de An치lisis y Dise침o de Software. Tu tarea es analizar las calificaciones de un estudiante y generar recomendaciones personalizadas para mejorar su rendimiento en cada actividad. Recibir치s una lista de calificaciones en el formato: [{"userid": number, "name": string, "grade": number, "actividad": string}, ...]. Para cada actividad, eval칰a la nota (que est치 en una escala de 0 a 10) y genera una recomendaci칩n espec칤fica basada en el rendimiento del estudiante. Si la nota es menor a 5, sugiere acciones para mejorar (por ejemplo, revisar conceptos espec칤ficos, practicar m치s ejercicios, o buscar ayuda adicional). Si la nota est치 entre 5 y 7, sugiere formas de consolidar el aprendizaje (por ejemplo, profundizar en temas espec칤ficos o aplicar conceptos en proyectos pr치cticos). Si la nota es mayor a 7, felicita al estudiante y sugiere c칩mo puede seguir avanzando (por ejemplo, explorar temas m치s avanzados o liderar proyectos). Devuelve las recomendaciones en formato JSON con la siguiente estructura: {"recomendaciones": [{"userid": number, "name": string, "grade": number, "actividad": string, "recomendacion": string}, ...]}. Responde en espa침ol.',JSON.stringify(notas),5e3).then((function(response){if(removeTutorLoader(),response.respuesta){var cleanedResponse=response.respuesta,jsonMatch=cleanedResponse.match(/{[\s\S]*}/),textoExplicativo=cleanedResponse;jsonMatch&&(textoExplicativo=cleanedResponse.substring(0,jsonMatch.index).trim(),cleanedResponse=jsonMatch[0]);try{var recomendaciones=JSON.parse(cleanedResponse);if(recomendaciones.recomendaciones&&recomendaciones.recomendaciones.length>0){var mensaje=`<div style='margin-bottom:8px;'><strong>Hola ${recomendaciones.recomendaciones[0].name}, he analizado tus calificaciones. Aqu칤 tienes algunas recomendaciones para mejorar:</strong></div>`;textoExplicativo&&(mensaje+=`<div style='color:#555;margin-bottom:8px;'>${textoExplicativo.replace(/\n/g,"<br>")}</div>`),mensaje+='<ul style="margin-left:18px;">',recomendaciones.recomendaciones.forEach((rec=>{mensaje+=`<li><strong>${rec.actividad}</strong> (Nota: ${rec.grade}):<br><span style='color:#007bff;'>${rec.recomendacion}</span></li>`})),showTutor(mensaje+="</ul>")}else showTutor("No se han obtenido recomendaciones para mostrar.")}catch(parseError){showTutor("Error al parsear las recomendaciones: "+parseError.message)}}else showTutor("Error: Respuesta inv치lida de la API.")})).catch((function(error){removeTutorLoader(),showTutor("Error al obtener recomendaciones: "+error.message)}))},error:function(xhr,status,error){removeTutorLoader(),showTutor("Error al obtener calificaciones: "+error+" (C칩digo: "+xhr.status+")")}})}showTutor("춰Bienvenido al chat de tutor칤a! Si tienes dudas sobre An치lisis y Dise침o de Software, tu progreso en el curso, o necesitas recomendaciones, no dudes en preguntar. Estoy aqu칤 para ayudarte."),$.ajax({url:`http://localhost:8080/api/users/${userid}`,method:"GET",dataType:"json",success:function(){localStorage.setItem("user_registered_"+userid,"true")},error:function(xhr){404===xhr.status&&obtenerContextoEstudiante(userid,courseid,!0).then((function(notas){var userfullname="Usuario Desconocido";notas&&notas.length>0&&notas[0].name&&(userfullname=notas[0].name),$.ajax({url:"http://localhost:8080/api/users/register",method:"POST",data:JSON.stringify({user_id:userid,username:"user_"+userid,role:role,userfullname:userfullname}),contentType:"application/json",success:function(){localStorage.setItem("user_registered_"+userid,"true")},error:function(){}})})).catch((function(){}))}}),verificarIntentosCuestionario();var btnIniciarEscaneo=$("#btn-iniciar-escaneo"),cooldownEscaneo=!1;btnIniciarEscaneo.length&&btnIniciarEscaneo.on("click",(function(){cooldownEscaneo?showTutor("Espera un momento antes de solicitar el an치lisis de desempe침o nuevamente."):(cooldownEscaneo=!0,btnIniciarEscaneo.prop("disabled",!0),btnIniciarEscaneo.text("Analizando..."),obtenerContextoEstudiante(userid,courseid,!0).then((function(){verificarIntentosCuestionario(obtenerRecomendaciones)})).catch((function(){showTutor("Error al obtener el contexto del estudiante para el an치lisis.")})).finally((function(){setTimeout((function(){cooldownEscaneo=!1,btnIniciarEscaneo.prop("disabled",!1),btnIniciarEscaneo.text("Ver desempe침o")}),1e4)})))})),form.length&&(chatInput.on("keydown",(function(e){"Enter"===e.key&&(e.shiftKey||(e.preventDefault(),form.trigger("submit")))})),form.on("submit",(function(e){if(e.preventDefault(),isChatBlocked)showTutor("No puedes enviar mensajes mientras est치s realizando un cuestionario en curso.");else{var message=chatInput.val();if(""!==message.trim()){if(function(texto){const textoLimpio=texto.trim().toLowerCase();return["hola","buenos dias","buenas tardes","buenas noches","hello","hi","saludos","que tal","c칩mo est치s","como estas"].some((saludo=>textoLimpio===saludo||textoLimpio.startsWith(saludo)))}(message)){var bubble=$('<div class="chat-bubble tutor-bubble"></div>').html("<span>춰Hola! Por favor, realiza preguntas relacionadas con An치lisis y Dise침o de Software o sobre tu progreso en el curso para que pueda ayudarte mejor.</span>");return messagesDiv.append(bubble),scrollToBottom(),void chatInput.val("")}!function(msg){var bubble=$('<div class="chat-bubble user-bubble"></div>').html("<span>"+$("<div>").text(msg).html()+"</span>");messagesDiv.append(bubble),scrollToBottom()}(message),chatInput.val(""),$.ajax({url:"http://localhost:8080/api/messages/save",method:"POST",data:JSON.stringify({user_id:userid,message_type:"input",message_text:message}),contentType:"application/json"}),showTutorLoader(),obtenerContextoEstudiante(userid,courseid).then((function(notas){llamarAPITutor("Act칰a como un profesor especializado en An치lisis y Dise침o de Software. Responde todas las preguntas relacionadas con el tema de forma clara, detallada y estructurada, utilizando ejemplos pr치cticos y profundizando en las teor칤as, principios y metodolog칤as que conforman el 치rea. Adem치s, si la pregunta est치 relacionada con el estudiante, sus calificaciones o su progreso, utiliza el siguiente contexto del estudiante para personalizar tu respuesta. Si el mensaje no est치 relacionado con An치lisis y Dise침o de Software o el curso, responde que solo puedes ayudar en esos temas. Responde en espa침ol de manera t칠cnica, pero accesible para estudiantes. CONTEXTO_ESTUDIANTE: "+JSON.stringify(notas),message,1e3).then((function(response){var tutorResponse=response.respuesta;showTutor(tutorResponse),$.ajax({url:"http://localhost:8080/api/messages/save",method:"POST",data:JSON.stringify({user_id:userid,message_type:"output",message_text:tutorResponse}),contentType:"application/json"})})).catch((function(error){showTutor("Error al conectar con la API: "+error.message)}))})).catch((function(){showTutor("Error al obtener el contexto del estudiante.")}))}}})))}}}));

//# sourceMappingURL=chat.min.js.map