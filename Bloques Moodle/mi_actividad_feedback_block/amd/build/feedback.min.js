define("block_mi_actividad_feedback_block/feedback",["jquery"],(function($){const API_Moodle="http://localhost/webservice/rest/server.php",API_BD_TUTOR_BASE="http://localhost:8080/api/";function llamarAPITutor(instruccion,entrada,maxTokens){return new Promise((function(resolve,reject){$.ajax({url:"http://localhost:8000/generar",method:"POST",contentType:"application/json",data:JSON.stringify({instruccion:instruccion,entrada:entrada,max_nuevos_tokens:maxTokens||256}),success:function(response){response.respuesta?resolve({respuesta:response.respuesta}):reject(new Error("Respuesta inválida de la API"))},error:function(xhr,status,error){reject(new Error(error))}})}))}return{init:function(userid,courseid,cmid,modname){var messagesDiv=$("#feedback-messages"),requestBtn=$("#feedback-request-btn"),cooldown=!1;function showTutorLoader(){var loader=$('<div class="tutor-bubble tutor-loader"></div>').html("<span><em>El tutor está escribiendo...</em></span>");messagesDiv.append(loader),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}function removeTutorLoader(){messagesDiv.find(".tutor-loader").remove()}function mostrarTextoAnimado(element,html){let velocidad=arguments.length>2&&void 0!==arguments[2]?arguments[2]:20;removeTutorLoader();var bubble=$('<div class="tutor-bubble typing-tutor"></div>');bubble.append("<span></span>"),element.append(bubble);var span=bubble.find("span"),safeHtml=html.replace(/\*\*([^*]+)\*\*/g,(function(match,p1){return"<b>"+p1.replace(/\n/g,"<br>")+"</b>"})).replace(/```([a-zA-Z]*)\n([\s\S]*?)```/g,(function(match,lang,code){return"<pre><code>"+$("<div>").text(code).html().replace(/\n/g,"<br>")+"</code></pre>"})).replace(/\n{2,}/g,"<br><br>").replace(/\n/g,"<br>").replace(/<(?!br\s*\/?>|b>|\/b>|strong>|\/strong>|i>|\/i>|pre>|\/pre>|code>|\/code>)[^>]+>/gi,""),i=0;!function typeChar(){i<=safeHtml.length?(span.html(safeHtml.slice(0,i)),element.scrollTop(element[0].scrollHeight),i++,setTimeout(typeChar,velocidad)):(span.html(safeHtml),bubble.removeClass("typing-tutor"),element.scrollTop(element[0].scrollHeight),bubble.find("pre code").each((function(){var formattedCode=$(this).html().replace(/<br\s*\/?>/gi,"\n");$(this).text(formattedCode)})))}()}function obtenerRetroalimentacion(){var params={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"gradereport_user_get_grade_items",moodlewsrestformat:"json",courseid:courseid,userid:userid},queryString=$.param(params),fullUrl=`${API_Moodle}?${queryString}`;showTutorLoader(),$.ajax({url:fullUrl,method:"GET",dataType:"json",success:function(data){removeTutorLoader();var actividadData=null;if(data.usergrades&&data.usergrades.forEach((user=>{user.gradeitems.forEach((item=>{if(item.cmid==cmid){var grade=null!==item.graderaw?item.graderaw:0;actividadData={userid:user.userid,name:user.userfullname,grade:grade,actividad:item.itemname,feedback:item.feedback||"Sin retroalimentación del profesor.",feedbackformat:item.feedbackformat||0}}}))})),!actividadData)return messagesDiv.append("<p><strong>Tutor:</strong> No se encontró una calificación para esta actividad o aún no ha sido calificada.</p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);if(1===actividadData.feedbackformat){var tempDiv=$("<div>").html(actividadData.feedback);actividadData.feedback=tempDiv.text()}var paramsContext={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"core_course_get_course_module",moodlewsrestformat:"json",cmid:cmid},queryStringContext=$.param(paramsContext),fullUrlContext=`${API_Moodle}?${queryStringContext}`;$.ajax({url:fullUrlContext,method:"GET",dataType:"json",success:function(contextData){if(removeTutorLoader(),!contextData.cm||!contextData.cm.instance)return messagesDiv.append("<p><strong>Tutor:</strong> No se pudo obtener el ID de la actividad.</p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);actividadData.id=contextData.cm.instance,"quiz"===modname?function(actividadData){var params={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"mod_quiz_get_user_attempts",moodlewsrestformat:"json",quizid:actividadData.id,userid:userid,status:"finished"},queryString=$.param(params),fullUrl=`${API_Moodle}?${queryString}`;showTutorLoader(),$.ajax({url:fullUrl,method:"GET",dataType:"json",success:function(data){if(removeTutorLoader(),!data.attempts||0===data.attempts.length)return messagesDiv.append("<p><strong>Tutor:</strong> No se encontraron intentos para este cuestionario.</p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);var attemptId=data.attempts[data.attempts.length-1].id,remainingAttempts=3-data.attempts.length;remainingAttempts<0&&(remainingAttempts=0),actividadData.remainingAttempts=remainingAttempts;var paramsAttempt={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"mod_quiz_get_attempt_review",moodlewsrestformat:"json",attemptid:attemptId,page:-1},queryStringAttempt=$.param(paramsAttempt),fullUrlAttempt=`${API_Moodle}?${queryStringAttempt}`;$.ajax({url:fullUrlAttempt,method:"GET",dataType:"json",success:function(attemptData){if(removeTutorLoader(),attemptData.warnings&&attemptData.warnings.length>0)return messagesDiv.append("<p><strong>Tutor:</strong> Advertencias: "+attemptData.warnings[0].message+"</p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);if(!attemptData.questions||0===attemptData.questions.length)return messagesDiv.append("<p><strong>Tutor:</strong> No se encontraron preguntas en el intento.</p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);var preguntasIncorrectas=[];attemptData.questions.forEach((question=>{var preguntaMatch=question.html.match(/<div class="qtext">(.*?)<\/div>/is),pregunta=preguntaMatch?preguntaMatch[1]:"No se pudo extraer la pregunta",numeroPregunta=question.questionnumber||"Desconocido",estado=question.status||"Desconocido",estadoInterno=question.state||"unknown",respuestaSeleccionadaMatch=question.html.match(/<input[^>]+checked="checked"[^>]*>.*?<div class="flex-fill ms-1">([^<]+)</is),respuestaSeleccionada=respuestaSeleccionadaMatch?respuestaSeleccionadaMatch[1]:"No se pudo extraer la respuesta seleccionada",respuestaCorrectaMatch=question.html.match(/<div class="rightanswer">La respuesta correcta es: ([^<]+)</is),respuestaCorrecta=respuestaCorrectaMatch?respuestaCorrectaMatch[1]:"No se pudo extraer la respuesta correcta",opciones=[],opcionesMatches=question.html.matchAll(/<div class="flex-fill ms-1">([^<]+)<\/div>/gis);for(let match of opcionesMatches)opciones.push(match[1]);"Incorrecta"!==estado&&"gradedwrong"!==estadoInterno||preguntasIncorrectas.push({numero:numeroPregunta,pregunta:pregunta,respuestaSeleccionada:respuestaSeleccionada,respuestaCorrecta:respuestaCorrecta,opciones:opciones,estado:estado})})),actividadData.preguntasIncorrectas=preguntasIncorrectas,0===preguntasIncorrectas.length?(messagesDiv.append("<p><strong>Tutor:</strong> ¡Felicidades! Respondiste todas las preguntas correctamente.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)):enviarDatosParaRetroalimentacion(actividadData)},error:function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener datos del intento.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}})},error:function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener intentos.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}})}(actividadData):"assign"===modname?function(actividadData){var paramsAssignment={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"mod_assign_get_assignments",moodlewsrestformat:"json",courseids:[courseid]},queryStringAssignment=$.param(paramsAssignment),fullUrlAssignment=`${API_Moodle}?${queryStringAssignment}`;showTutorLoader(),$.ajax({url:fullUrlAssignment,method:"GET",dataType:"json",success:function(assignmentData){removeTutorLoader();var assignment=null;if(assignmentData.courses&&assignmentData.courses.length>0&&assignmentData.courses.forEach((course=>{course.assignments.forEach((assign=>{assign.cmid==cmid&&(assignment=assign)}))})),!assignment)return messagesDiv.append("<p><strong>Tutor:</strong> No se encontró información sobre la tarea.</p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);if(actividadData.title=assignment.name,actividadData.description=assignment.intro||"Sin descripción disponible.",actividadData.introformat=assignment.introformat||0,1===actividadData.introformat){var tempDiv=$("<div>").html(actividadData.description);actividadData.description=tempDiv.text()}var paramsSubmission={wstoken:"10b97b49ec5c5119e48c566de5228f8f",wsfunction:"mod_assign_get_submissions",moodlewsrestformat:"json",assignmentids:[actividadData.id]},queryStringSubmission=$.param(paramsSubmission),fullUrlSubmission=`${API_Moodle}?${queryStringSubmission}`;$.ajax({url:fullUrlSubmission,method:"GET",dataType:"json",success:function(submissionData){removeTutorLoader();var entregaEstudiante=null;submissionData.assignments&&submissionData.assignments.length>0&&(entregaEstudiante=submissionData.assignments[0].submissions.find((sub=>sub.userid==userid)));if(!entregaEstudiante)return actividadData.status="pendiente",actividadData.submissionStatus="No entregada",void enviarDatosParaRetroalimentacion(actividadData);actividadData.status=entregaEstudiante.status||"entregada",actividadData.submissionStatus="submitted"===entregaEstudiante.status?"Entregada":"Borrador","submitted"===actividadData.status&&(actividadData.grade>0?actividadData.status="calificada":actividadData.status="entregada_no_calificada"),enviarDatosParaRetroalimentacion(actividadData)},error:function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener entregas.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}})},error:function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener datos de la tarea.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}})}(actividadData):(messagesDiv.append("<p><strong>Tutor:</strong> Este tipo de actividad no es compatible para análisis detallado.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight))},error:function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener contextid.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}})},error:function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener calificaciones.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}})}function enviarDatosParaRetroalimentacion(actividadData){showTutorLoader(),$.ajax({url:`${API_BD_TUTOR_BASE}messages/save`,method:"POST",data:JSON.stringify({user_id:userid,message_type:"feed_input",message_text:JSON.stringify(actividadData)}),contentType:"application/json"});if(actividadData.preguntasIncorrectas&&actividadData.preguntasIncorrectas.length>0)if(actividadData.remainingAttempts>0){llamarAPITutor("Proporciona retroalimentación de apoyo basada en los temas de las preguntas incorrectas.",`\n                            Eres un tutor virtual especializado en Análisis y Diseño de Software. Un estudiante ha respondido incorrectamente algunas preguntas en un cuestionario, pero aún tiene ${actividadData.remainingAttempts} intento(s) restante(s). Proporciona retroalimentación de apoyo que identifique los temas principales de las preguntas incorrectas y ofrezca consejos generales para mejorar, sin revelar las respuestas correctas ni detalles específicos de las preguntas.\n\n                            Preguntas incorrectas:\n                            ${actividadData.preguntasIncorrectas.map(((pregunta,index)=>`\n                            Pregunta ${index+1} (Número ${pregunta.numero}): ${pregunta.pregunta}\n                            `)).join("\n")}\n\n                            Identifica los temas principales (por ejemplo, modelado UML, casos de uso, diagramas de clases) y sugiere cómo mejorar en ellos (máximo 150 palabras). Comienza con "¡No te preocupes, estás progresando!" y usa un tono motivador. No menciones respuestas correctas ni hagas referencia a libros o materiales externos.\n                        `,256).then((function(response){if(removeTutorLoader(),response.respuesta){var mensaje=`<p><strong>Tutor:</strong><br>${response.respuesta.replace(/\n/g,"<br>")}<br>Tienes ${actividadData.remainingAttempts} intento(s) restante(s). ¡Sigue practicando!</p>`;mostrarTextoAnimado(messagesDiv,mensaje),messagesDiv.scrollTop(messagesDiv[0].scrollHeight),$.ajax({url:`${API_BD_TUTOR_BASE}messages/save`,method:"POST",data:JSON.stringify({user_id:userid,message_type:"feed_output",message_text:response.respuesta}),contentType:"application/json"})}else messagesDiv.append("<p><strong>Tutor:</strong> Error: No se pudo generar la retroalimentación de apoyo.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)})).catch((function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener retroalimentación de apoyo.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}))}else{var promesas=actividadData.preguntasIncorrectas.map((pregunta=>llamarAPITutor("Proporciona una explicación clara y detallada.",`\n                                Eres un tutor virtual especializado en Análisis y Diseño de Software. Explica por qué la respuesta correcta es adecuada para la siguiente pregunta de un cuestionario, considerando el contexto y las opciones disponibles.\n\n                                **Pregunta**: ${pregunta.pregunta}\n                                **Respuesta seleccionada**: ${pregunta.respuestaSeleccionada} (incorrecta)\n                                **Respuesta correcta**: ${pregunta.respuestaCorrecta}\n                                **Opciones**: ${pregunta.opciones.join(", ")}\n\n                                Explica por qué "${pregunta.respuestaCorrecta}" es correcta y por qué "${pregunta.respuestaSeleccionada}" no lo es. Usa un lenguaje claro, educativo y motivador (máximo 100 palabras).\n                            `,256).then((function(response){if(removeTutorLoader(),response.respuesta){var mensaje=`<p><strong>Tutor:</strong> Pregunta ${pregunta.numero}: "${pregunta.pregunta}":<br><strong>Respondiste:</strong> "${pregunta.respuestaSeleccionada}" (Incorrecta).<br><strong>Correcta:</strong> "${pregunta.respuestaCorrecta}".<br><strong>Explicación:</strong> ${response.respuesta}</p>`;mostrarTextoAnimado(messagesDiv,mensaje),messagesDiv.scrollTop(messagesDiv[0].scrollHeight),$.ajax({url:`${API_BD_TUTOR_BASE}messages/save`,method:"POST",data:JSON.stringify({user_id:userid,message_type:"feed_output",message_text:response.respuesta}),contentType:"application/json"})}})).catch((function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener retroalimentación para la Pregunta.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}))));Promise.all(promesas).then((()=>actividadData.grade<7?llamarAPITutor("Proporciona una actividad de refuerzo basada en los errores del estudiante.",`\n                                    Eres un tutor virtual especializado en Análisis y Diseño de Software. Un estudiante obtuvo una calificación de ${actividadData.grade} en un cuestionario (escala 0-10). Propón una actividad de refuerzo para mejorar en los temas de los preguntas incorrectas:\n\n                                    ${actividadData.preguntasIncorrectas.map(((pregunta,index)=>`\n                                    Pregunta ${index+1} (Número ${pregunta.numero}): ${pregunta.pregunta}\n                                    Respuesta seleccionada: ${pregunta.respuestaSeleccionada} (incorrecta)\n                                    Respuesta correcta: ${pregunta.respuestaCorrecta}\n                                    `)).join("\n")}\n\n                                    Identifica los temas de los errores y propone una actividad práctica y breve (máximo 200 palabras) que aborde todos los temas. Comienza con "¡Vamos a reforzar tus conocimientos!" and usa un tono motivador. No menciones libros ni materiales externos.\n                                `,256).then((function(response){if(removeTutorLoader(),response.respuesta){var actividadFormateada=response.respuesta.replace(/\n/g,"<br>");mostrarTextoAnimado(messagesDiv,`<p><strong>Tutor:</strong><br><strong>Actividad de refuerzo:</strong><br>${actividadFormateada}</p>`),messagesDiv.scrollTop(messagesDiv[0].scrollHeight),$.ajax({url:`${API_BD_TUTOR_BASE}messages/save`,method:"POST",data:JSON.stringify({user_id:userid,message_type:"feed_output",message_text:response.respuesta}),contentType:"application/json"})}else messagesDiv.append("<p><strong>Tutor:</strong> Error: No se pudo generar la actividad de refuerzo.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)})).catch((function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al generar actividad de refuerzo.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)})):null)).catch((()=>{removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al procesar retroalimentaciones.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}))}else llamarAPITutor('\n                    Actúa como un tutor virtual especializado en la enseñanza de Análisis y Diseño de Software. Tu tarea es proporcionar retroalimentación educativa a un estudiante basada en el estado de una tarea. Recibirás los datos en el formato: \n                    {\n                        "userid": number, \n                        "name": string, \n                        "grade": number, \n                        "actividad": string, \n                        "title": string, \n                        "description": string, \n                        "status": string ("pendiente", "entregada_no_calificada", "calificada"), \n                        "submissionStatus": string, \n                        "feedback": string\n                    }\n                    \n                    - Si el estado es "pendiente", analiza el título y la descripción de la tarea y proporciona recomendaciones específicas para que el estudiante la complete exitosamente.\n                    - Si el estado es "entregada_no_calificada", informa al estudiante que su tarea está en proceso de evaluación y sugiere cómo puede prepararse para futuras tareas similares.\n                    - Si el estado es "calificada", analiza la calificación y la retroalimentación del profesor para proporcionar retroalimentación adicional. Explica qué hizo bien el estudiante, qué puede mejorar, y sugiere pasos específicos para futuras tareas.\n                    \n                    Devuelve la retroalimentación en formato texto, en español, con un tono profesional y motivador.\n                ',JSON.stringify(actividadData),256).then((function(response){if(removeTutorLoader(),response.respuesta){var cleanedResponse=response.respuesta,jsonMatch=cleanedResponse.match(/{[\s\S]*}/),textoExplicativo=cleanedResponse;jsonMatch&&(textoExplicativo=cleanedResponse.substring(0,jsonMatch.index).trim(),cleanedResponse=jsonMatch[0]);var mensaje=`<p><strong>Tutor:</strong> Hola ${actividadData.name}, aquí tienes la retroalimentación para "${actividadData.actividad}":</p>`;textoExplicativo&&(mensaje+=`<div style='color:#555;margin-bottom:8px;'>${textoExplicativo.replace(/\n/g,"<br>")}</div>`);try{var recomendaciones=JSON.parse(cleanedResponse);recomendaciones.recomendaciones&&recomendaciones.recomendaciones.length>0?(mensaje+='<ul style="margin-left:18px;">',recomendaciones.recomendaciones.forEach((rec=>{mensaje+=`<li><strong>${rec.actividad}</strong> (Nota: ${rec.grade}):<br><span style='color:#007bff;'>${rec.recomendacion}</span></li>`})),mensaje+="</ul>"):recomendaciones.recomendacion&&(mensaje+=`<div style='color:#007bff;'>${recomendaciones.recomendacion}</div>`)}catch(e){textoExplicativo||(mensaje+=`<div>${response.respuesta.replace(/\n/g,"<br>")}</div>`)}mostrarTextoAnimado(messagesDiv,mensaje),messagesDiv.scrollTop(messagesDiv[0].scrollHeight),$.ajax({url:`${API_BD_TUTOR_BASE}messages/save`,method:"POST",data:JSON.stringify({user_id:userid,message_type:"feed_output",message_text:response.respuesta}),contentType:"application/json"})}else messagesDiv.append("<p><strong>Tutor:</strong> Error: Respuesta inválida de la API.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)})).catch((function(){removeTutorLoader(),messagesDiv.append("<p><strong>Tutor:</strong> Error al obtener retroalimentación.</p>"),messagesDiv.scrollTop(messagesDiv[0].scrollHeight)}))}requestBtn.length&&requestBtn.on("click",(function(){if(cooldown)return messagesDiv.append("<p><strong>Espera unos segundos antes de volver a solicitar retroalimentación.</strong></p>"),void messagesDiv.scrollTop(messagesDiv[0].scrollHeight);cooldown=!0,requestBtn.prop("disabled",!0),obtenerRetroalimentacion(),setTimeout((function(){cooldown=!1,requestBtn.prop("disabled",!1)}),1e4)}))}}}));

//# sourceMappingURL=feedback.min.js.map