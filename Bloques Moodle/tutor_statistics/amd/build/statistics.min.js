define("block_tutor_statistics/statistics",["jquery","core/str"],(function($,str){function waitForChart(callback){"undefined"==typeof Chart?setTimeout((function(){waitForChart(callback)}),100):callback()}return{init:function(){var statisticsDiv=$("#statistics-content"),isLoading=!1;!function(){if(isLoading)return;isLoading=!0;str.get_strings([{key:"no_data",component:"block_tutor_statistics"}]).then((function(translations){var noDataString=translations[0];waitForChart((function(){$.ajax({url:"http://localhost:8080/api/statistics",method:"GET",dataType:"json",success:function(statisticsResponse){$.ajax({url:"http://localhost:8080/api/messages",method:"GET",dataType:"json",success:function(messagesResponse){var topicChartContainer=$("#top-question-chart").parent();$("#top-question-chart").remove(),$("#top-topic-chart").remove(),statisticsDiv.find(".conclusion-container").remove();var allInputs=messagesResponse.filter((function(msg){return"input"===msg.message_type})).map((function(msg){return msg.message_text})),tutorPayload={top_user:statisticsResponse.top_user,total_messages:statisticsResponse.total_messages,peak_hour:statisticsResponse.peak_hour,total_peak_hour_messages:statisticsResponse.total_peak_hour_messages,inputs:allInputs};$.ajax({url:"http://localhost:8000/generar",method:"POST",contentType:"application/json",data:JSON.stringify({instruccion:'\n                                            Actúa como un tutor virtual especializado en Análisis y Diseño de Software. Recibirás estadísticas y todas las preguntas realizadas por los estudiantes (inputs) en el siguiente formato JSON:\n                                            {\n                                                "top_user": { "userfullname": string, "total_messages": number },\n                                                "total_messages": number,\n                                                "peak_hour": { "hour_of_day": number, "message_count": number },\n                                                "total_peak_hour_messages": number,\n                                                "inputs": [string]\n                                            }\n                                            Analiza todas las preguntas y devuelve un array JSON llamado "temas" con los 3 temas principales a reforzar (solo nombres de temas, sin explicación). Luego, genera una breve conclusión en español (máximo 50 palabras) recomendando reforzar esos temas para todos los estudiantes del curso, no solo para un usuario. No menciones datos personales ni preguntas exactas.\n                                        ',entrada:JSON.stringify(tutorPayload),max_nuevos_tokens:256}),success:function(apiResponse){isLoading=!1;var temas=Array.isArray(apiResponse.temas)?apiResponse.temas:[],conclusionText="string"==typeof apiResponse.conclusion?apiResponse.conclusion:apiResponse.respuesta||"";if(!temas.length&&conclusionText){var match=conclusionText.match(/temas?:\s*([\w\s,áéíóúÁÉÍÓÚüÜñÑ-]+)/i);match&&match[1]&&(temas=match[1].split(",").map((function(t){return t.trim()})).filter(Boolean))}topicChartContainer.find("#top-topic-chart").remove(),topicChartContainer.append('<canvas id="top-topic-chart"></canvas>');var topTopicCanvas=document.getElementById("top-topic-chart");if(topTopicCanvas){var topTopicCtx=topTopicCanvas.getContext("2d");new Chart(topTopicCtx,{type:"doughnut",data:{labels:temas.length?temas:["Sin temas detectados"],datasets:[{label:"Temas a Reforzar",data:temas.length?temas.map((function(){return 1})):[1],backgroundColor:["#dc3545","#007bff","#28a745"],borderColor:["#c82333","#0056b3","#218838"],borderWidth:1}]},options:{plugins:{legend:{position:"bottom",labels:{font:{size:13,weight:"bold"}}},tooltip:{callbacks:{label:function(context){return context.label}}}},animation:{duration:1200,easing:"easeOutQuart"}}})}conclusionText?statisticsDiv.append(`\n                                                        <div class="conclusion-container">\n                                                            <h4>Conclusión del Uso del Tutor Virtual</h4>\n                                                            <p>${conclusionText.replace(/\n/g,"<br>")}</p>\n                                                        </div>\n                                                    `):statisticsDiv.append('<p style="color:#c00;">No se pudo obtener una conclusión válida del tutor.</p>')},error:function(xhr,status,error){isLoading=!1,statisticsDiv.append('<p style="color:#c00;">Error al generar la conclusión: '+error+"</p>")}})},error:function(xhr,status,error){isLoading=!1,statisticsDiv.html('<p style="color:#c00;">Error al cargar los mensajes: '+error+"</p>")}});var topUserCtx=$("#top-user-chart")[0].getContext("2d");if(statisticsResponse.top_user&&statisticsResponse.total_messages>0){var topUserMessages=statisticsResponse.top_user.total_messages||0,otherMessages=statisticsResponse.total_messages-topUserMessages;new Chart(topUserCtx,{type:"pie",data:{labels:[statisticsResponse.top_user.userfullname||"Usuario Desconocido","Otros Usuarios"],datasets:[{label:"Número de Mensajes",data:[topUserMessages,otherMessages],backgroundColor:["#007bff","#d3d3d3"],borderColor:["#0056b3","#a9a9a9"],borderWidth:1}]},options:{plugins:{legend:{position:"bottom",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(context){return context.label+": "+context.raw+" mensajes"}}}},animation:{duration:1e3,easing:"easeOutQuart"}}})}else $("#top-user-chart").replaceWith("<p>"+noDataString+" (Usuario Más Activo)</p>");var peakHourCtx=$("#peak-hour-chart")[0].getContext("2d");if(statisticsResponse.peak_hour&&statisticsResponse.total_peak_hour_messages>0){var peakHourMessages=statisticsResponse.peak_hour.message_count||0,otherHourMessages=statisticsResponse.total_peak_hour_messages-peakHourMessages;new Chart(peakHourCtx,{type:"pie",data:{labels:["Hora "+statisticsResponse.peak_hour.hour_of_day,"Otras Horas"],datasets:[{label:"Mensajes en Hora Pico",data:[peakHourMessages,otherHourMessages],backgroundColor:["#28a745","#d3d3d3"],borderColor:["#218838","#a9a9a9"],borderWidth:1}]},options:{plugins:{legend:{position:"bottom",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(context){return context.label+": "+context.raw+" mensajes"}}}},animation:{duration:1e3,easing:"easeOutQuart"}}})}else $("#peak-hour-chart").replaceWith("<p>"+noDataString+" (Hora de Mayor Uso)</p>")},error:function(xhr,status,error){isLoading=!1,statisticsDiv.html('<p style="color:#c00;">Error al cargar las estadísticas: '+error+"</p>")}})}))})).fail((function(error){isLoading=!1,statisticsDiv.html('<p style="color:#c00;">Error al cargar las estadísticas: No se pudieron cargar las traducciones.</p>')}))}()}}}));

//# sourceMappingURL=statistics.min.js.map