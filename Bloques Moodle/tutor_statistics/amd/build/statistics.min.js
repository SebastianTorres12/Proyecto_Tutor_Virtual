define("block_tutor_statistics/statistics",["jquery","core/str"],(function($,str){function waitForChart(callback){"undefined"==typeof Chart?setTimeout((function(){waitForChart(callback)}),100):callback()}return{init:function(){var statisticsDiv=$("#statistics-content"),isLoading=!1;!function(){if(isLoading)return;isLoading=!0;str.get_strings([{key:"no_data",component:"block_tutor_statistics"}]).then((function(translations){var noDataString=translations[0];waitForChart((function(){$.ajax({url:"http://localhost:8080/api/statistics",method:"GET",dataType:"json",success:function(statisticsResponse){$.ajax({url:"http://localhost:8080/api/messages",method:"GET",dataType:"json",success:function(messagesResponse){var topicChartContainer=$("#top-question-chart").parent();$("#top-question-chart").remove(),$("#top-topic-chart").remove(),statisticsDiv.find(".conclusion-container").remove();var instruccion,entrada,maxTokens,allInputs=messagesResponse.filter((function(msg){return"input"===msg.message_type})).map((function(msg){return msg.message_text})),tutorPayload={top_user:statisticsResponse.top_user,total_messages:statisticsResponse.total_messages,peak_hour:statisticsResponse.peak_hour,total_peak_hour_messages:statisticsResponse.total_peak_hour_messages,inputs:allInputs},loader=$('<div class="tutor-loader" style="margin:16px 0;text-align:center;font-style:italic;color:#28a745;">El tutor está analizando los datos...</div>');statisticsDiv.append(loader),(instruccion='\n                                            Actúa como un tutor virtual especializado en la enseñanza de Análisis y Diseño de Software. Recibirás estadísticas y todas las preguntas realizadas por los estudiantes (inputs) en el siguiente formato JSON:\n                                            {\n                                                "top_user": { "userfullname": string, "total_messages": number },\n                                                "total_messages": number,\n                                                "peak_hour": { "hour_of_day": number, "message_count": number },\n                                                "total_peak_hour_messages": number,\n                                                "inputs": [string]\n                                            }\n                                            Analiza todas las preguntas y responde SOLO con un objeto JSON válido, sin explicaciones ni formato adicional, con estas tres propiedades:\n                                            - "temas": un array con los 3 temas generales principales a reforzar (por ejemplo, "Modelado UML", "Patrones de Diseño", "Metodologías de Desarrollo de Software", "Requisitos", "Arquitectura de Software", "Testing", etc. Elige los más representativos y evita temas demasiado específicos o repetidos).\n                                            - "temasCount": un array con el número de mensajes detectados para cada tema, en el mismo orden que el array de temas (por ejemplo, [5, 3, 2]).\n                                            - "conclusion": una conclusión breve y elaborada en español (máximo 50 palabras) dirigida al profesor, explicando por qué reforzar esos temas en el curso, basada en el análisis real de las preguntas de los estudiantes.\n                                            No incluyas datos personales ni preguntas exactas. No incluyas ejemplos de respuesta en tu salida. NO uses formato Markdown ni listas, SOLO el JSON.\n                                        ',entrada=JSON.stringify(tutorPayload),maxTokens=256,new Promise((function(resolve,reject){$.ajax({url:"http://localhost:8000/generar",method:"POST",contentType:"application/json",data:JSON.stringify({instruccion:instruccion,entrada:entrada,max_nuevos_tokens:maxTokens||256}),success:function(response){response.respuesta?resolve({respuesta:response.respuesta}):reject(new Error("Respuesta inválida de la API"))},error:function(xhr,status,error){reject(new Error(error))}})}))).then((function(apiResponse){isLoading=!1,loader.remove();try{var jsonString=apiResponse.respuesta,temas=[],temasCount=[],conclusionText="",trimmed="string"==typeof jsonString?jsonString.trim():"";if(trimmed.startsWith("{")){var lastBrace=trimmed.lastIndexOf("}"),jsonBlock="";jsonBlock=-1!==lastBrace?trimmed.substring(0,lastBrace+1):trimmed+"}";try{var parsed=JSON.parse(jsonBlock);temas=Array.isArray(parsed.temas)?parsed.temas:[],temasCount=Array.isArray(parsed.temasCount)?parsed.temasCount:[],conclusionText="string"==typeof parsed.conclusion?parsed.conclusion:""}catch(jsonError){return void statisticsDiv.append('<p style="color:#c00;">Error: El bloque JSON no se pudo parsear, incluso agregando la llave de cierre.</p>')}}else{var jsonMatch="string"==typeof jsonString?jsonString.match(/{[\s\S]*}/):null;if(!jsonMatch)return void statisticsDiv.append('<p style="color:#c00;">Error: No se encontró bloque JSON en la respuesta del tutor.</p>');var cleanJson=jsonMatch[0];parsed=JSON.parse(cleanJson);temas=Array.isArray(parsed.temas)?parsed.temas:[],temasCount=Array.isArray(parsed.temasCount)?parsed.temasCount:[],conclusionText="string"==typeof parsed.conclusion?parsed.conclusion:""}}catch(e){return void statisticsDiv.append('<p style="color:#c00;">Error: No se pudo parsear la respuesta del tutor.</p>')}temas.length>3&&(temas=temas.slice(0,3),temasCount=temasCount.slice(0,3)),topicChartContainer.find("#top-topic-chart").remove(),topicChartContainer.append('<canvas id="top-topic-chart"></canvas>');var topTopicCanvas=document.getElementById("top-topic-chart");if(topTopicCanvas){var topTopicCtx=topTopicCanvas.getContext("2d"),colorCount=temas.length>0?temas.length:1,chartColors=["#dc3545","#007bff","#28a745","#ffc107","#17a2b8","#6610f2","#fd7e14","#6f42c1","#20c997","#e83e8c"].slice(0,colorCount),chartBorders=["#c82333","#0056b3","#218838","#e0a800","#117a8b","#520dc2","#e8590c","#5a189a","#198754","#d63384"].slice(0,colorCount),chartLabels=temas.length?temas.map((function(t,i){return t+" ("+(temasCount[i]||0)+")"})):["Sin temas detectados"];new Chart(topTopicCtx,{type:"doughnut",data:{labels:chartLabels,datasets:[{label:"Temas a Reforzar",data:temasCount,backgroundColor:chartColors,borderColor:chartBorders,borderWidth:2}]},options:{plugins:{legend:{position:"bottom",labels:{font:{size:10,weight:"bold"},color:"#222",padding:12,boxWidth:18}},tooltip:{callbacks:{label:function(context){return"Tema: "+(context.label||"")+" - "+(context.raw||0)+" mensajes"}}}},animation:{duration:1200,easing:"easeOutQuart"}}})}if(conclusionText){var temasList=temas.length?temas.join(", "):"Sin temas detectados";statisticsDiv.append(`\n                                                        <div class="conclusion-container">\n                                                            <h4>Recomendación para el Profesor/a</h4>\n                                                            <p><strong>Profesor/a:</strong> Se recomienda reforzar los siguientes temas: <b>${temasList}</b>.<br>Razón: ${conclusionText.replace(/\n/g,"<br>")}</p>\n                                                        </div>\n                                                    `)}else statisticsDiv.append('<p style="color:#c00;">No se pudo obtener una conclusión válida del tutor.</p>')})).catch((function(error){isLoading=!1,loader.remove(),statisticsDiv.append('<p style="color:#c00;">Error al generar la conclusión: '+error.message+"</p>")}))},error:function(xhr,status,error){isLoading=!1,statisticsDiv.html('<p style="color:#c00;">Error al cargar los mensajes: '+error+"</p>")}});var topUserCtx=$("#top-user-chart")[0].getContext("2d");if(statisticsResponse.top_user&&statisticsResponse.total_messages>0){var topUserMessages=statisticsResponse.top_user.total_messages||0,otherMessages=statisticsResponse.total_messages-topUserMessages;new Chart(topUserCtx,{type:"pie",data:{labels:[statisticsResponse.top_user.userfullname||"Usuario Desconocido","Otros Usuarios"],datasets:[{label:"Número de Mensajes",data:[topUserMessages,otherMessages],backgroundColor:["#007bff","#d3d3d3"],borderColor:["#0056b3","#a9a9a9"],borderWidth:1}]},options:{plugins:{legend:{position:"bottom",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(context){return context.label+": "+context.raw+" mensajes"}}}},animation:{duration:1e3,easing:"easeOutQuart"}}})}else $("#top-user-chart").replaceWith("<p>"+noDataString+" (Usuario Más Activo)</p>");var peakHourCtx=$("#peak-hour-chart")[0].getContext("2d");if(statisticsResponse.peak_hour&&statisticsResponse.total_peak_hour_messages>0){var peakHourMessages=statisticsResponse.peak_hour.message_count||0,otherHourMessages=statisticsResponse.total_peak_hour_messages-peakHourMessages;new Chart(peakHourCtx,{type:"pie",data:{labels:["Hora "+statisticsResponse.peak_hour.hour_of_day,"Otras Horas"],datasets:[{label:"Mensajes en Hora Pico",data:[peakHourMessages,otherHourMessages],backgroundColor:["#28a745","#d3d3d3"],borderColor:["#218838","#a9a9a9"],borderWidth:1}]},options:{plugins:{legend:{position:"bottom",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(context){return context.label+": "+context.raw+" mensajes"}}}},animation:{duration:1e3,easing:"easeOutQuart"}}})}else $("#peak-hour-chart").replaceWith("<p>"+noDataString+" (Hora de Mayor Uso)</p>")},error:function(xhr,status,error){isLoading=!1,statisticsDiv.html('<p style="color:#c00;">Error al cargar las estadísticas: '+error+"</p>")}})}))})).fail((function(error){isLoading=!1,statisticsDiv.html('<p style="color:#c00;">Error al cargar las estadísticas: No se pudieron cargar las traducciones.</p>')}))}()}}}));

//# sourceMappingURL=statistics.min.js.map