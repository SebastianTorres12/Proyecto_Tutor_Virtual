{"version":3,"file":"statistics.min.js","sources":["../src/statistics.js"],"sourcesContent":["/* eslint-disable brace-style */\n/* eslint-disable camelcase */\n/* eslint-disable no-unused-vars */\n/* eslint-disable no-undef */\n/* eslint-disable jsdoc/require-jsdoc */\n/* eslint-disable promise/always-return */\n/* eslint-disable max-len */\ndefine(['jquery', 'core/str'], function($, str) {\n    // Definición de variables generales para las APIs\n    const API_BD_TUTOR_BASE = 'http://localhost:8080/api/'; // Base URL para la API de base de datos (se añaden endpoints específicos)\n    const API_tutor = 'http://localhost:8000/generar'; // API para generar respuestas del tutor\n\n    // Función para esperar a que Chart.js esté disponible\n    function waitForChart(callback) {\n        if (typeof Chart !== 'undefined') {\n            callback();\n            return;\n        }\n        setTimeout(function() {\n            waitForChart(callback);\n        }, 100);\n    }\n\n    return {\n        init: function() {\n            var statisticsDiv = $('#statistics-content');\n            var isLoading = false;\n            // Eliminar lógica de toggle y solo cargar estadísticas automáticamente\n            cargarEstadisticas();\n\n            function cargarEstadisticas() {\n                if (isLoading) {\n                    return;\n                }\n                isLoading = true;\n                // Obtener la cadena de idioma necesaria\n                var strings = [\n                    {key: 'no_data', component: 'block_tutor_statistics'}\n                ];\n\n                str.get_strings(strings).then(function(translations) {\n                    var noDataString = translations[0];\n                    waitForChart(function() {\n                        // Obtener estadísticas desde la API\n                        $.ajax({\n                            url: `${API_BD_TUTOR_BASE}statistics`,\n                            method: 'GET',\n                            dataType: 'json',\n                            success: function(statisticsResponse) {\n                                $.ajax({\n                                    url: `${API_BD_TUTOR_BASE}messages`,\n                                    method: 'GET',\n                                    dataType: 'json',\n                                    success: function(messagesResponse) {\n                                        // --- Eliminar cualquier gráfico/conclusión previo ---\n                                        var topicChartContainer = $('#top-question-chart').parent();\n                                        $('#top-question-chart').remove();\n                                        $('#top-topic-chart').remove();\n                                        statisticsDiv.find('.conclusion-container').remove();\n                                        // Enviar todos los inputs al tutor para análisis de temas\n                                        var inputMessages = messagesResponse.filter(function(msg) {\n                                            return msg.message_type === 'input';\n                                        });\n                                        var allInputs = inputMessages.map(function(msg) { return msg.message_text; });\n                                        var conclusionPrompt = `\n                                            Actúa como un tutor virtual especializado en la enseñanza de Análisis y Diseño de Software. Recibirás estadísticas y todas las preguntas realizadas por los estudiantes (inputs) en el siguiente formato JSON:\n                                            {\n                                                \"top_user\": { \"userfullname\": string, \"total_messages\": number },\n                                                \"total_messages\": number,\n                                                \"peak_hour\": { \"hour_of_day\": number, \"message_count\": number },\n                                                \"total_peak_hour_messages\": number,\n                                                \"inputs\": [string]\n                                            }\n                                            Analiza todas las preguntas y devuelve un objeto JSON con dos propiedades:\n                                            - \"temas\": un array con los 3 temas principales a reforzar (solo nombres de temas, sin explicación, NO uses ejemplos genéricos ni repitas los del prompt, y NO repitas temas en el array).\n                                            - \"conclusion\": una conclusión breve y elaborada en español (máximo 50 palabras) dirigida al profesor, explicando por qué reforzar esos temas en el curso, basada en el análisis real de las preguntas de los estudiantes.\n                                            No incluyas datos personales ni preguntas exactas. No incluyas ejemplos de respuesta en tu salida.\n                                        `;\n                                        var tutorPayload = {\n                                            top_user: statisticsResponse.top_user,\n                                            total_messages: statisticsResponse.total_messages,\n                                            peak_hour: statisticsResponse.peak_hour,\n                                            total_peak_hour_messages: statisticsResponse.total_peak_hour_messages,\n                                            inputs: allInputs\n                                        };\n                                        // --- Loader visual mientras el tutor analiza ---\n                                        var loader = $('<div class=\"tutor-loader\" style=\"margin:16px 0;text-align:center;font-style:italic;color:#28a745;\">El tutor está analizando los datos...</div>');\n                                        statisticsDiv.append(loader);\n                                        $.ajax({\n                                            url: API_tutor,\n                                            method: 'POST',\n                                            contentType: 'application/json',\n                                            data: JSON.stringify({\n                                                instruccion: conclusionPrompt,\n                                                entrada: JSON.stringify(tutorPayload),\n                                                max_nuevos_tokens: 256\n                                            }),\n                                            success: function(apiResponse) {\n                                                isLoading = false;\n                                                loader.remove();\n                                                // Validar formato de respuesta\n                                                var temas = Array.isArray(apiResponse.temas) ? apiResponse.temas : [];\n                                                var conclusionText = typeof apiResponse.conclusion === 'string' ? apiResponse.conclusion : (apiResponse.respuesta || '');\n                                                // Si no hay array de temas, intentar extraerlos del texto (mejorado para frases compuestas y saltos de línea)\n                                                if (!temas.length && conclusionText) {\n                                                    var match = conclusionText.match(/temas?:\\s*([\\w\\s,;áéíóúÁÉÍÓÚüÜñÑ\\-]+)(?:\\.|\\n|$)/i);\n                                                    if (match && match[1]) {\n                                                        temas = match[1]\n                                                            .split(/,|;|\\n|\\r|\\.|\\u2022|\\-/)\n                                                            .map(function(t) { return t.trim(); })\n                                                            .filter(Boolean);\n                                                    }\n                                                }\n                                                // Si la respuesta viene como string JSON, parsearla correctamente\n                                                if (!temas.length && conclusionText && conclusionText.trim().startsWith('{')) {\n                                                    try {\n                                                        var parsed = JSON.parse(conclusionText);\n                                                        if (Array.isArray(parsed.temas)) {\n                                                            temas = parsed.temas;\n                                                        }\n                                                        if (typeof parsed.conclusion === 'string') {\n                                                            conclusionText = parsed.conclusion;\n                                                        }\n                                                    } catch (e) {\n                                                        // Si falla el parseo, se mantiene el fallback\n                                                    }\n                                                }\n                                                // Limitar a solo 3 temas\n                                                if (temas.length > 3) {\n                                                    temas = temas.slice(0, 3);\n                                                }\n                                                // Mostrar gráfico de temas SOLO con los datos del tutor\n                                                topicChartContainer.find('#top-topic-chart').remove();\n                                                topicChartContainer.append('<canvas id=\"top-topic-chart\"></canvas>');\n                                                var topTopicCanvas = document.getElementById('top-topic-chart');\n                                                if (topTopicCanvas) {\n                                                    var topTopicCtx = topTopicCanvas.getContext('2d');\n                                                    new Chart(topTopicCtx, {\n                                                        type: 'doughnut',\n                                                        data: {\n                                                            labels: temas.length ? temas : ['Sin temas detectados'],\n                                                            datasets: [{\n                                                                label: 'Temas a Reforzar',\n                                                                data: temas.length ? temas.map(function() { return 1; }) : [1],\n                                                                backgroundColor: ['#dc3545', '#007bff', '#28a745'],\n                                                                borderColor: ['#c82333', '#0056b3', '#218838'],\n                                                                borderWidth: 1\n                                                            }]\n                                                        },\n                                                        options: {\n                                                            plugins: {\n                                                                legend: {\n                                                                    position: 'bottom',\n                                                                    labels: {\n                                                                        font: {size: 13, weight: 'bold'}\n                                                                    }\n                                                                },\n                                                                tooltip: {\n                                                                    callbacks: {\n                                                                        label: function(context) {\n                                                                            return context.label;\n                                                                        }\n                                                                    }\n                                                                }\n                                                            },\n                                                            animation: {\n                                                                duration: 1200,\n                                                                easing: 'easeOutQuart'\n                                                            }\n                                                        }\n                                                    });\n                                                }\n                                                // Mostrar conclusión enfocada al profesor\n                                                if (conclusionText) {\n                                                    var temasList = temas.length ? temas.join(', ') : 'Sin temas detectados';\n                                                    statisticsDiv.append(`\n                                                        <div class=\"conclusion-container\">\n                                                            <h4>Recomendación para el Profesor/a</h4>\n                                                            <p><strong>Profesor/a:</strong> Se recomienda reforzar los siguientes temas: <b>${temasList}</b>.<br>Razón: ${conclusionText.replace(/\\n/g, '<br>')}</p>\n                                                        </div>\n                                                    `);\n                                                } else {\n                                                    statisticsDiv.append('<p style=\"color:#c00;\">No se pudo obtener una conclusión válida del tutor.</p>');\n                                                }\n                                            },\n                                            error: function(xhr, status, error) {\n                                                isLoading = false;\n                                                loader.remove();\n                                                statisticsDiv.append('<p style=\"color:#c00;\">Error al generar la conclusión: ' + error + '</p>');\n                                            }\n                                        });\n                                    },\n                                    error: function(xhr, status, error) {\n                                        isLoading = false;\n                                        statisticsDiv.html('<p style=\"color:#c00;\">Error al cargar los mensajes: ' + error + '</p>');\n                                    }\n                                });\n                                // Gráfico para el usuario más activo (Pie Chart)\n                                var topUserCtx = $('#top-user-chart')[0].getContext('2d');\n                                if (statisticsResponse.top_user && statisticsResponse.total_messages > 0) {\n                                    var topUserMessages = statisticsResponse.top_user.total_messages || 0;\n                                    var otherMessages = statisticsResponse.total_messages - topUserMessages;\n                                    new Chart(topUserCtx, {\n                                        type: 'pie',\n                                        data: {\n                                            labels: [statisticsResponse.top_user.userfullname || 'Usuario Desconocido', 'Otros Usuarios'],\n                                            datasets: [{\n                                                label: 'Número de Mensajes',\n                                                data: [topUserMessages, otherMessages],\n                                                backgroundColor: ['#007bff', '#d3d3d3'],\n                                                borderColor: ['#0056b3', '#a9a9a9'],\n                                                borderWidth: 1\n                                            }]\n                                        },\n                                        options: {\n                                            plugins: {\n                                                legend: {\n                                                    position: 'bottom',\n                                                    labels: {\n                                                        font: {size: 12}\n                                                    }\n                                                },\n                                                tooltip: {\n                                                    callbacks: {\n                                                        label: function(context) {\n                                                            return context.label + ': ' + context.raw + ' mensajes';\n                                                        }\n                                                    }\n                                                }\n                                            },\n                                            animation: {\n                                                duration: 1000,\n                                                easing: 'easeOutQuart'\n                                            }\n                                        }\n                                    });\n                                } else {\n                                    $('#top-user-chart').replaceWith('<p>' + noDataString + ' (Usuario Más Activo)</p>');\n                                }\n\n                                // Gráfico para la hora de mayor uso (Pie Chart)\n                                var peakHourCtx = $('#peak-hour-chart')[0].getContext('2d');\n                                if (statisticsResponse.peak_hour && statisticsResponse.total_peak_hour_messages > 0) {\n                                    var peakHourMessages = statisticsResponse.peak_hour.message_count || 0;\n                                    var otherHourMessages = statisticsResponse.total_peak_hour_messages - peakHourMessages;\n                                    new Chart(peakHourCtx, {\n                                        type: 'pie',\n                                        data: {\n                                            labels: ['Hora ' + statisticsResponse.peak_hour.hour_of_day, 'Otras Horas'],\n                                            datasets: [{\n                                                label: 'Mensajes en Hora Pico',\n                                                data: [peakHourMessages, otherHourMessages],\n                                                backgroundColor: ['#28a745', '#d3d3d3'],\n                                                borderColor: ['#218838', '#a9a9a9'],\n                                                borderWidth: 1\n                                            }]\n                                        },\n                                        options: {\n                                            plugins: {\n                                                legend: {\n                                                    position: 'bottom',\n                                                    labels: {\n                                                        font: {size: 12}\n                                                    }\n                                                },\n                                                tooltip: {\n                                                    callbacks: {\n                                                        label: function(context) {\n                                                            return context.label + ': ' + context.raw + ' mensajes';\n                                                        }\n                                                    }\n                                                }\n                                            },\n                                            animation: {\n                                                duration: 1000,\n                                                easing: 'easeOutQuart'\n                                            }\n                                        }\n                                    });\n                                } else {\n                                    $('#peak-hour-chart').replaceWith('<p>' + noDataString + ' (Hora de Mayor Uso)</p>');\n                                }\n                            },\n                            error: function(xhr, status, error) {\n                                isLoading = false;\n                                statisticsDiv.html('<p style=\"color:#c00;\">Error al cargar las estadísticas: ' + error + '</p>');\n                            }\n                        });\n                    });\n                }).fail(function(error) {\n                    isLoading = false;\n                    statisticsDiv.html('<p style=\"color:#c00;\">Error al cargar las estadísticas: No se pudieron cargar las traducciones.</p>');\n                });\n            }\n        }\n    };\n});"],"names":["define","$","str","waitForChart","callback","Chart","setTimeout","init","statisticsDiv","isLoading","get_strings","key","component","then","translations","noDataString","ajax","url","method","dataType","success","statisticsResponse","messagesResponse","topicChartContainer","parent","remove","find","allInputs","filter","msg","message_type","map","message_text","tutorPayload","top_user","total_messages","peak_hour","total_peak_hour_messages","inputs","loader","append","contentType","data","JSON","stringify","instruccion","entrada","max_nuevos_tokens","apiResponse","temas","Array","isArray","conclusionText","conclusion","respuesta","length","match","split","t","trim","Boolean","startsWith","parsed","parse","e","slice","topTopicCanvas","document","getElementById","topTopicCtx","getContext","type","labels","datasets","label","backgroundColor","borderColor","borderWidth","options","plugins","legend","position","font","size","weight","tooltip","callbacks","context","animation","duration","easing","temasList","join","replace","error","xhr","status","html","topUserCtx","topUserMessages","otherMessages","userfullname","raw","replaceWith","peakHourCtx","peakHourMessages","message_count","otherHourMessages","hour_of_day","fail","cargarEstadisticas"],"mappings":"AAOAA,OAAM,oCAAC,CAAC,SAAU,aAAa,SAASC,EAAGC,KAMvC,SAASC,aAAaC,UACG,oBAAVC,MAIXC,YAAW,WACPH,aAAaC,SAChB,GAAE,KALCA,UAMR,CAEA,MAAO,CACHG,KAAM,WACF,IAAIC,cAAgBP,EAAE,uBAClBQ,WAAY,GAIhB,WACI,GAAIA,UACA,OAEJA,WAAY,EAMZP,IAAIQ,YAJU,CACV,CAACC,IAAK,UAAWC,UAAW,4BAGPC,MAAK,SAASC,cACnC,IAAIC,aAAeD,aAAa,GAChCX,cAAa,WAETF,EAAEe,KAAK,CACHC,IAAK,uCACLC,OAAQ,MACRC,SAAU,OACVC,QAAS,SAASC,oBACdpB,EAAEe,KAAK,CACHC,IAAK,qCACLC,OAAQ,MACRC,SAAU,OACVC,QAAS,SAASE,kBAEd,IAAIC,oBAAsBtB,EAAE,uBAAuBuB,SACnDvB,EAAE,uBAAuBwB,SACzBxB,EAAE,oBAAoBwB,SACtBjB,cAAckB,KAAK,yBAAyBD,SAE5C,IAGIE,UAHgBL,iBAAiBM,QAAO,SAASC,KACjD,MAA4B,UAArBA,IAAIC,YACf,IAC8BC,KAAI,SAASF,KAAO,OAAOA,IAAIG,YAAc,IAevEC,aAAe,CACfC,SAAUb,mBAAmBa,SAC7BC,eAAgBd,mBAAmBc,eACnCC,UAAWf,mBAAmBe,UAC9BC,yBAA0BhB,mBAAmBgB,yBAC7CC,OAAQX,WAGRY,OAAStC,EAAE,kJACfO,cAAcgC,OAAOD,QACrBtC,EAAEe,KAAK,CACHC,IA/EtB,gCAgFsBC,OAAQ,OACRuB,YAAa,mBACbC,KAAMC,KAAKC,UAAU,CACjBC,YA7Be,wkDA8BfC,QAASH,KAAKC,UAAUX,cACxBc,kBAAmB,MAEvB3B,QAAS,SAAS4B,aACdvC,WAAY,EACZ8B,OAAOd,SAEP,IAAIwB,MAAQC,MAAMC,QAAQH,YAAYC,OAASD,YAAYC,MAAQ,GAC/DG,eAAmD,iBAA3BJ,YAAYK,WAA0BL,YAAYK,WAAcL,YAAYM,WAAa,GAErH,IAAKL,MAAMM,QAAUH,eAAgB,CACjC,IAAII,MAAQJ,eAAeI,MAAM,qDAC7BA,OAASA,MAAM,KACfP,MAAQO,MAAM,GACTC,MAAM,0BACN1B,KAAI,SAAS2B,GAAK,OAAOA,EAAEC,MAAQ,IACnC/B,OAAOgC,SAEpB,CAEA,IAAKX,MAAMM,QAAUH,gBAAkBA,eAAeO,OAAOE,WAAW,KACpE,IACI,IAAIC,OAASnB,KAAKoB,MAAMX,gBACpBF,MAAMC,QAAQW,OAAOb,SACrBA,MAAQa,OAAOb,OAEc,iBAAtBa,OAAOT,aACdD,eAAiBU,OAAOT,WAEhC,CAAE,MAAOW,GAET,CAGAf,MAAMM,OAAS,IACfN,MAAQA,MAAMgB,MAAM,EAAG,IAG3B1C,oBAAoBG,KAAK,oBAAoBD,SAC7CF,oBAAoBiB,OAAO,0CAC3B,IAAI0B,eAAiBC,SAASC,eAAe,mBAC7C,GAAIF,eAAgB,CAChB,IAAIG,YAAcH,eAAeI,WAAW,MAC5C,IAAIjE,MAAMgE,YAAa,CACnBE,KAAM,WACN7B,KAAM,CACF8B,OAAQvB,MAAMM,OAASN,MAAQ,CAAC,wBAChCwB,SAAU,CAAC,CACPC,MAAO,mBACPhC,KAAMO,MAAMM,OAASN,MAAMlB,KAAI,WAAa,OAAO,CAAG,IAAK,CAAC,GAC5D4C,gBAAiB,CAAC,UAAW,UAAW,WACxCC,YAAa,CAAC,UAAW,UAAW,WACpCC,YAAa,KAGrBC,QAAS,CACLC,QAAS,CACLC,OAAQ,CACJC,SAAU,SACVT,OAAQ,CACJU,KAAM,CAACC,KAAM,GAAIC,OAAQ,UAGjCC,QAAS,CACLC,UAAW,CACPZ,MAAO,SAASa,SACZ,OAAOA,QAAQb,KACnB,KAIZc,UAAW,CACPC,SAAU,KACVC,OAAQ,kBAIxB,CAEA,GAAItC,eAAgB,CAChB,IAAIuC,UAAY1C,MAAMM,OAASN,MAAM2C,KAAK,MAAQ,uBAClDpF,cAAcgC,OAAO,oVAGqEmD,4BAA4BvC,eAAeyC,QAAQ,MAAO,oIAGxJ,MACIrF,cAAcgC,OAAO,iFAE5B,EACDsD,MAAO,SAASC,IAAKC,OAAQF,OACzBrF,WAAY,EACZ8B,OAAOd,SACPjB,cAAcgC,OAAO,0DAA4DsD,MAAQ,OAC7F,GAEP,EACDA,MAAO,SAASC,IAAKC,OAAQF,OACzBrF,WAAY,EACZD,cAAcyF,KAAK,wDAA0DH,MAAQ,OACzF,IAGJ,IAAII,WAAajG,EAAE,mBAAmB,GAAGqE,WAAW,MACpD,GAAIjD,mBAAmBa,UAAYb,mBAAmBc,eAAiB,EAAG,CACtE,IAAIgE,gBAAkB9E,mBAAmBa,SAASC,gBAAkB,EAChEiE,cAAgB/E,mBAAmBc,eAAiBgE,gBACxD,IAAI9F,MAAM6F,WAAY,CAClB3B,KAAM,MACN7B,KAAM,CACF8B,OAAQ,CAACnD,mBAAmBa,SAASmE,cAAgB,sBAAuB,kBAC5E5B,SAAU,CAAC,CACPC,MAAO,qBACPhC,KAAM,CAACyD,gBAAiBC,eACxBzB,gBAAiB,CAAC,UAAW,WAC7BC,YAAa,CAAC,UAAW,WACzBC,YAAa,KAGrBC,QAAS,CACLC,QAAS,CACLC,OAAQ,CACJC,SAAU,SACVT,OAAQ,CACJU,KAAM,CAACC,KAAM,MAGrBE,QAAS,CACLC,UAAW,CACPZ,MAAO,SAASa,SACZ,OAAOA,QAAQb,MAAQ,KAAOa,QAAQe,IAAM,WAChD,KAIZd,UAAW,CACPC,SAAU,IACVC,OAAQ,kBAIxB,MACIzF,EAAE,mBAAmBsG,YAAY,MAAQxF,aAAe,6BAI5D,IAAIyF,YAAcvG,EAAE,oBAAoB,GAAGqE,WAAW,MACtD,GAAIjD,mBAAmBe,WAAaf,mBAAmBgB,yBAA2B,EAAG,CACjF,IAAIoE,iBAAmBpF,mBAAmBe,UAAUsE,eAAiB,EACjEC,kBAAoBtF,mBAAmBgB,yBAA2BoE,iBACtE,IAAIpG,MAAMmG,YAAa,CACnBjC,KAAM,MACN7B,KAAM,CACF8B,OAAQ,CAAC,QAAUnD,mBAAmBe,UAAUwE,YAAa,eAC7DnC,SAAU,CAAC,CACPC,MAAO,wBACPhC,KAAM,CAAC+D,iBAAkBE,mBACzBhC,gBAAiB,CAAC,UAAW,WAC7BC,YAAa,CAAC,UAAW,WACzBC,YAAa,KAGrBC,QAAS,CACLC,QAAS,CACLC,OAAQ,CACJC,SAAU,SACVT,OAAQ,CACJU,KAAM,CAACC,KAAM,MAGrBE,QAAS,CACLC,UAAW,CACPZ,MAAO,SAASa,SACZ,OAAOA,QAAQb,MAAQ,KAAOa,QAAQe,IAAM,WAChD,KAIZd,UAAW,CACPC,SAAU,IACVC,OAAQ,kBAIxB,MACIzF,EAAE,oBAAoBsG,YAAY,MAAQxF,aAAe,2BAEhE,EACD+E,MAAO,SAASC,IAAKC,OAAQF,OACzBrF,WAAY,EACZD,cAAcyF,KAAK,4DAA8DH,MAAQ,OAC7F,GAER,GACJ,IAAGe,MAAK,SAASf,OACbrF,WAAY,EACZD,cAAcyF,KAAK,uGACvB,GACJ,CAzQAa,EA0QJ,EAER"}